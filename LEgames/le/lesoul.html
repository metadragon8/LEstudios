<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LEsoul</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #050505;
            font-family: 'Orbitron', sans-serif;
        }

        canvas { display: block; width: 100%; height: 100%; }

        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            padding: 20px;
        }

        .hud-top {
            display: flex; justify-content: space-between; align-items: center;
        }
        .score-board {
            color: #0ff; font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px cyan;
        }
        .hp-bar-frame {
            width: 150px; height: 8px; background: rgba(255,255,255,0.1);
            border: 1px solid #555; border-radius: 4px; overflow: hidden;
        }
        .hp-bar-fill {
            width: 100%; height: 100%; background: #00ff00;
            box-shadow: 0 0 8px #0f0; transition: width 0.2s;
        }

        
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50px;
            width: 120px; height: 120px;
            pointer-events: auto; 
            display: flex; justify-content: center; align-items: center;
            
        }
        #joy-base {
            width: 90px; height: 90px;
            border: 2px solid rgba(0, 255, 255, 0.1);
            border-radius: 50%; position: absolute;
        }
        #joy-stick {
            width: 45px; height: 45px;
            background: rgba(0, 255, 255, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0,255,255,0.3);
            position: relative;
            transition: transform 0.1s; 
        }

        @media (min-width: 1024px) { 
            #joystick-zone { display: none; } 
        }

        
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
            pointer-events: auto;
        }
        .hidden { display: none !important; }

        h1 { color: #0ff; font-size: 2.5rem; text-shadow: 0 0 20px cyan; margin-bottom: 10px; text-align: center;}
        .btn {
            background: transparent; color: #0ff; border: 2px solid #0ff;
            padding: 15px 40px; font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 0 10px rgba(0,255,255,0.2); margin-top: 20px;
        }
        .btn:active { transform: scale(0.95); background: rgba(0,255,255,0.1); }
    </style>
</head>
<body>
    
    <canvas id="cvs"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="score-board" id="sc">0</div>
            <div class="hp-bar-frame"><div class="hp-bar-fill" id="hp"></div></div>
        </div>
        <div id="joystick-zone">
            <div id="joy-base"></div>
            <div id="joy-stick"></div>
        </div>
    </div>

    <div id="start-menu" class="modal">
        <h1>SOUL KEEPER</h1>
        <p style="color:#777; letter-spacing: 2px;">MOBILE RE-ENGINEERED</p>
        <button class="btn" onclick="start()">SYSTEM START</button>
    </div>

    <div id="game-over" class="modal hidden">
        <h1 style="color: #ff4444; text-shadow: 0 0 20px red;">FATAL ERROR</h1>
        <p style="color:#aaa; font-size: 1.2rem;">Enemies Eliminated: <span id="final-score" style="color:#fff;">0</span></p>
        <button class="btn" style="color:#ff4444; border-color:#ff4444;" onclick="start()">REBOOT</button>
    </div>

    <script>
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        let W, H;

        
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let actx = new AudioCtx();
        
        function sfx(t) {
            if(actx.state==='suspended') actx.resume();
            let o=actx.createOscillator(), g=actx.createGain();
            o.connect(g); g.connect(actx.destination);
            
            if(t==='s'){ 
                o.type='square'; o.frequency.setValueAtTime(800, actx.currentTime);
                o.frequency.exponentialRampToValueAtTime(100, actx.currentTime+0.15);
                g.gain.value=0.04; o.start(); o.stop(actx.currentTime+0.15);
            } 
else if(t==='die'){ 
        o.type='triangle';
        o.frequency.setValueAtTime(200, actx.currentTime); 
        o.frequency.exponentialRampToValueAtTime(10, actx.currentTime+0.3); 
        g.gain.setValueAtTime(0.1, actx.currentTime);
        g.gain.linearRampToValueAtTime(0, actx.currentTime+0.3);
        o.start(); o.stop(actx.currentTime+0.3);
    }

else { 
                o.type='sawtooth'; o.frequency.value=100;
                g.gain.value=0.08; o.start(); o.stop(actx.currentTime+0.1);
            }
        }

       
        let run = false, score = 0, frames = 0;
        let bullets = [], enemies = [], particles = [];
        
        const p = {
            x: 0, y: 0,
            s: 5, 
            a: 0, 
            hp: 100,
            sh: 0 
        };

        
        const input = { 
            u:false, d:false, l:false, r:false, 
            mx:0, my:0, 
            activeAim: false 
        };
        
        
        const joy = { on:false, x:0, y:0, sx:0, sy:0, id:null, el:document.getElementById('joy-stick') };

        function resize() {
            W = cvs.width = window.innerWidth;
            H = cvs.height = window.innerHeight;
            if(!run) { p.x = W/2; p.y = H/2; }
        }
        window.addEventListener('resize', resize);
        
        
        
        
        window.addEventListener('keydown', e=>{
            let k=e.code;
            if(k==='KeyW'||k==='ArrowUp') input.u=true;
            if(k==='KeyS'||k==='ArrowDown') input.d=true;
            if(k==='KeyA'||k==='ArrowLeft') input.l=true;
            if(k==='KeyD'||k==='ArrowRight') input.r=true;
        });
        window.addEventListener('keyup', e=>{
            let k=e.code;
            if(k==='KeyW'||k==='ArrowUp') input.u=false;
            if(k==='KeyS'||k==='ArrowDown') input.d=false;
            if(k==='KeyA'||k==='ArrowLeft') input.l=false;
            if(k==='KeyD'||k==='ArrowRight') input.r=false;
        });

        
        window.addEventListener('mousemove', e => {
            input.activeAim = true; 
            input.mx = e.clientX;
            input.my = e.clientY;
        });
        window.addEventListener('mousedown', e => shoot(e.clientX, e.clientY));

        
        const zone = document.getElementById('joystick-zone');
        
        
        zone.addEventListener('touchstart', e => {
            e.preventDefault();
            let t = e.changedTouches[0];
            joy.id = t.identifier; joy.on = true;
            joy.sx = t.clientX; joy.sy = t.clientY;
        }, {passive:false});

        zone.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++){
                let t = e.changedTouches[i];
                if(t.identifier === joy.id) {
                    let dx = t.clientX - joy.sx;
                    let dy = t.clientY - joy.sy;
                    let dist = Math.min(Math.hypot(dx,dy), 45); 
                    let ang = Math.atan2(dy, dx);
                    joy.x = (Math.cos(ang)*dist) / 45; 
                    joy.y = (Math.sin(ang)*dist) / 45;
                    joy.el.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
                }
            }
        }, {passive:false});

        const joyEnd = (e) => {
            for(let i=0; i<e.changedTouches.length; i++){
                if(e.changedTouches[i].identifier === joy.id) {
                    joy.on=false; joy.x=0; joy.y=0;
                    joy.el.style.transform = `translate(0,0)`;
                    
                    
                    input.activeAim = false;
                }
            }
        };
        zone.addEventListener('touchend', joyEnd);

        
        cvs.addEventListener('touchstart', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++){
                let t = e.changedTouches[i];
                
                if(t.clientX > W/3) {
                    input.activeAim = true;
                    input.mx = t.clientX;
                    input.my = t.clientY;
                    shoot(t.clientX, t.clientY);
                }
            }
        }, {passive:false});

        cvs.addEventListener('touchmove', e => {
            
            for(let i=0; i<e.changedTouches.length; i++){
                let t = e.changedTouches[i];
                if(t.clientX > W/3) {
                    input.activeAim = true;
                    input.mx = t.clientX;
                    input.my = t.clientY;
                }
            }
        }, {passive:false});


        
        
        function shoot(tx, ty) {
            if(!run) return;
            sfx('s');
            
            
            let ang = Math.atan2(ty - p.y, tx - p.x);
            p.x -= Math.cos(ang)*4; p.y -= Math.sin(ang)*4;

            
            p.a = ang; 

            bullets.push({
                x:p.x, y:p.y, vx:Math.cos(ang)*15, vy:Math.sin(ang)*15, l:50
            });
        }

        function spawn() {
            
            let ex, ey;
            if(Math.random()<.5) { ex=Math.random()<0.5?-50:W+50; ey=Math.random()*H; }
            else { ex=Math.random()*W; ey=Math.random()<0.5?-50:H+50; }

            let diff = score/60; 
            let s = 2 + Math.random() + diff;
            let hp = 1;
            let col = '#00ffff'; 

            if(score>20 && Math.random()>.7) { col='#ff00ff'; s*=1.4; hp=2; } 
            if(score>50 && Math.random()>.85) { col='#ff0000'; s*=0.7; hp=5; } 

            enemies.push({x:ex, y:ey, vx:0, vy:0, s:s, hp:hp, c:col});
        }

        function loop() {
            if(!run) return;
            requestAnimationFrame(loop);
            frames++;

            ctx.fillStyle = 'rgba(5,5,8,0.3)'; 
            ctx.fillRect(0,0,W,H);

            
            let mx = joy.x; 
            let my = joy.y;
            if(input.u) my = -1; if(input.d) my = 1;
            if(input.l) mx = -1; if(input.r) mx = 1;

            
            if(mx!==0 || my!==0) {
                let d = Math.hypot(mx,my);
                if(d>1) { mx/=d; my/=d; }
            }

            p.x += mx * p.s;
            p.y += my * p.s;
            p.x = Math.max(20, Math.min(W-20, p.x));
            p.y = Math.max(20, Math.min(H-20, p.y));
            
            p.sh += 0.1; 

            
            if (input.activeAim) {
                p.a = Math.atan2(input.my - p.y, input.mx - p.x);
            }
            
            else if (Math.abs(mx) > 0.1 || Math.abs(my) > 0.1) {
                let moveAngle = Math.atan2(my, mx);
                
                let diff = moveAngle - p.a;
                
                while (diff < -Math.PI) diff += Math.PI*2;
                while (diff > Math.PI) diff -= Math.PI*2;
                p.a += diff * 0.2; 
            }

            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.a);
            
            
            
            ctx.shadowBlur=15; ctx.shadowColor=p.hp>30?'#0ff':'#f00';
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(15,0); ctx.lineTo(-10, 12); ctx.lineTo(-5,0); ctx.lineTo(-10,-12);
            ctx.fill();

            
            ctx.rotate(-p.a); 
            ctx.rotate(p.sh); 
            ctx.strokeStyle = p.hp>30?'#0ff':'#f00'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.arc(0,0,28, 0, 1.5); ctx.stroke();
            ctx.beginPath(); ctx.arc(0,0,28, 3.14, 4.6); ctx.stroke();

            ctx.restore();


            
            ctx.shadowColor='#ff0'; ctx.shadowBlur=10; ctx.fillStyle='#ff0';
            for(let i=bullets.length-1; i>=0; i--) {
                let b=bullets[i];
                b.x+=b.vx; b.y+=b.vy; b.l--;
                ctx.beginPath(); ctx.arc(b.x,b.y, 4, 0, 6.28); ctx.fill();
                if(b.l<0 || b.x<0 || b.x>W || b.y<0 || b.y>H) bullets.splice(i,1);
            }

            
            if(frames%(score>30?25:50)===0) spawn(); 

            for(let i=enemies.length-1; i>=0; i--) {
                let e = enemies[i];
                let ang = Math.atan2(p.y-e.y, p.x-e.x);
                e.x += Math.cos(ang)*e.s;
                e.y += Math.sin(ang)*e.s;

                
                ctx.shadowColor=e.c; ctx.shadowBlur=15; ctx.fillStyle=e.c;
                
                let jx = (Math.random()-.5)*3;
                let jy = (Math.random()-.5)*3;
                ctx.beginPath(); ctx.arc(e.x+jx, e.y+jy, 16, 0, 6.28); ctx.fill();
                
                
                ctx.fillStyle='#000'; ctx.shadowBlur=0;
                let ex=Math.cos(ang)*5, ey=Math.sin(ang)*5;
                ctx.beginPath(); ctx.arc(e.x+ex-5, e.y+ey-3, 3,0,6.28); ctx.fill();
                ctx.beginPath(); ctx.arc(e.x+ex+5, e.y+ey-3, 3,0,6.28); ctx.fill();

                
                let d = Math.hypot(p.x-e.x, p.y-e.y);
                if(d < 35) {
                    p.hp -= 15;
                    updateUI();
                    blast(p.x, p.y, '#f00', 10); 
                    sfx('h');
                    enemies.splice(i,1);
                    continue;
                }

                
                for(let j=bullets.length-1; j>=0; j--) {
                    let b=bullets[j];
                    if(Math.hypot(b.x-e.x, b.y-e.y) < 25) {
                        e.hp--; 
                        e.x -= Math.cos(ang)*15; 
                        bullets.splice(j,1);
                        if(e.hp<=0) {
                            score++; 
                            document.getElementById('sc').innerText=score;
                            blast(e.x,e.y,e.c, 8);
                             sfx('die');

                            enemies.splice(i,1);
                        }
                        break;
                    }
                }
            }

            
            ctx.shadowBlur=0;
            for(let i=particles.length-1; i>=0; i--) {
                let pt = particles[i];
                pt.x+=pt.vx; pt.y+=pt.vy; pt.l-=0.05;
                ctx.globalAlpha=pt.l; ctx.fillStyle=pt.c;
                ctx.beginPath(); ctx.arc(pt.x, pt.y, Math.random()*3, 0, 6.28); ctx.fill();
                if(pt.l<=0) particles.splice(i,1);
            }
            ctx.globalAlpha=1;

            
            if(p.hp<=0) gameOver();
        }

        function blast(x,y,c,n) {
            for(let i=0;i<n;i++) particles.push({
                x:x, y:y, vx:(Math.random()-.5)*10, vy:(Math.random()-.5)*10, l:1, c:c
            });
        }

        function updateUI() {
            let bar = document.getElementById('hp');
            bar.style.width = Math.max(0, p.hp)+'%';
            bar.style.background = p.hp>50 ? '#0f0' : (p.hp>25 ? '#ff0' : '#f00');
            bar.style.boxShadow = `0 0 10px ${bar.style.background}`;
        }

        function start() {
            resize(); 
            input.mx = W/2 + 100; 
            input.my = H/2;
            input.activeAim = false;

            score=0; p.hp=100; 
            bullets=[]; enemies=[]; particles=[];
            
            document.getElementById('start-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('sc').innerText=0;
            updateUI();
            
            run=true;
            requestAnimationFrame(loop);
        }

        function gameOver() {
            run=false;
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over').classList.remove('hidden');
        }
        
       
        resize();

    </script>
</body>
</html>